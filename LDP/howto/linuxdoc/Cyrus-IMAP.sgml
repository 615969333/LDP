<!doctype linuxdoc system>

<article>
<title> Cyrus IMAP HOWTO</title>
<author>Aurora Skarra-Gallagher (Community Vision)</author>
<date>v1.0, 5 July 2000</date>
<abstract>A comprehensive guide to installing, configuring, and running Cyrus Imap and Cyrus
Sasl
</abstract>
<toc>

<sect>About this HOWTO

<sect1>Copyrights and Trademarks
<p>(c) 2000 Aurora Skarra-Gallagher</p>
<p>This section was copied from the HOWTO-HOWTO:</p>
<p>This manual may be reproduced in whole or in part, without fee, subject to the following restrictions: </p>
<p><itemize>
<item>The copyright notice above and this permission notice must be preserved complete on all complete or partial copies 
<item>Any translation or derived work must be approved by the author in writing before distribution. 
<item>If you distribute this work in part, instructions for obtaining the complete version of this manual must be included, and a means for obtaining a complete version provided. 
<item>Small portions may be reproduced as illustrations for reviews or quotes in other works without this permission notice if proper citation is given. Exceptions to these rules may be granted for academic purposes: Write to the author and ask. These restrictions are here to protect us as authors, not to restrict you as learners and educators. Any source code (aside from the SGML this document was written in) in this document is placed under the GNU General Public License, available via anonymous FTP from the GNU archive. 
</itemize></p>

<sect1>Feedback
<p>Comments (especially corrections) can be sent to 
<url url="mailto:asg@CommunityVision.com" name="asg@CommunityVision.com"></p>

<sect1>Document Conventions
<p><itemize>
<item><em>Italics</em> signifies a  directory
<item><tt>This font</tt> signifies instructions to be ran at the command line
</itemize></p>

<sect>Obtaining the Files

<sect1>Cyrus Imap Homepage
<p>The homepage is currently located at: </p>
<p><url url="http://asg.web.cmu.edu/cyrus/imapd" name="http://asg.web.cmu.edu/cyrus/imapd"></p>

<sect1>Downloading the files
<p>You will need both IMAP and SASL. Download the latest files here: </p>
<p><url url="ftp://ftp.andrew.cmu.edu/pub/cyrus-mail" name="ftp://ftp.andrew.cmu.edu/pub/cyrus-mail"><p>
<p>Download cyrus-imapd-X.X.X.tar.gz and cyrus-sasl-X.X.X.tar.gz (where X.X.X is the latest release) into
your temporary directory. </p>
<p>I will use the directory <em>/temp</em> as the directory I've uncompressed the files under for the rest of the examples. </p>

<sect>Cyrus SASL

<sect1>Uncompress
<p>Here we untar and gunzip the file in a single step. </p>
<p><enum>
<item><tt> cd /temp</tt>
<item><tt> tar -zxvf cyrus-sasl-X.X.X.tar.gz</tt>
<item><tt> cd cyrus-sasl-X.X.X</tt>
</enum></p>

<sect1>Building the files
<p>For most purposes, the following set of instructions works fine. If you would like to examine the
other configuration options, type <tt>./configure --help | more</tt></p>
<p><enum>
<item><tt> ./configure</tt>
<item><tt> make</tt>
<item><tt> make install</tt>
</enum></p>
<p>If you don't want your password check to be the default sasldb, you must specify
which one of PAM, kerberos_v4, passwd, shadow you wish to use. If PAM is the
authentication you desire for example, you would type: </p>
<p><tt>./configure --pwcheck_method=PAM</tt></p>
<p>instead of the ./configure line above</p>

<sect>Cyrus IMAP Installation

<sect1>Uncompress
<p>The following commands will tar and gunzip cyrus IMAP under the <em>/temp</em> directory. </p>
<p><enum>
<item><tt>cd /temp</tt>
<item><tt>tar -zxvf tar/cyrus-imapd-1.6.24.tar.gz</tt>
<item><tt>cd cyrus-imapd-1.6.24</tt>
</enum></p>

<sect1>A note on com_err.h
<p>When I tried to install cyrus IMAP, I got errors regarding the file com_err.h. My com_err.h was
located in the <em>/usr/include/et</em> directory. It needs to reside in the <em>/usr/include</em>
directory. Run the following command to make sure it is in the correct location:</p>
<p><tt>locate com_err.h</tt></p> 
<p>This will show you where the file is. If it is under the <em>/usr/include</em> directory, 
you can skip to the next section. If it is in another directory, just copy it to the
<em>/usr/include</em> directory. If it doesn't exist, download it here: 
<url url="http://www.ludd.luth.se/~jnilsson/cvsweb/cvsweb.cgi/src/contrib/com_err"
name="http://www.ludd.luth.se/~jnilsson/cvsweb/cvsweb.cgi/src/contrib/com_err">.</p>

<sect1>Configure

<p><tt> ./configure --with-auth=unix</tt></p>

<sect1>Adding the default user
<p>Cyrus requires a user to own its files. The default user is cyrus. The following command adds a user
cyrus with the group of "mail"</p>
<p><tt>useradd -g mail cyrus</tt></p>
<p>You'll want to set the password for user cyrus.</p>
<p><tt>passwd cyrus</tt></p>
<p>Type in the password you desire cyrus to have each time you are prompted</p>

<sect1>Building the files
<p><enum>
<item><tt> make depend </tt>
<item><tt> make all CFLAGS=-O</tt>
<item><tt> make install</tt>
</enum></p>
<p> That's it! You've installed SASL and are ready to install IMAP. </p>

<sect> Cyrus IMAP Configuration

<sect1>Editing conf files
<p><enum>
<item>Edit /etc/syslog.conf and add the following lines at the bottom:
<verb>	local6.debug	/var/adm/imapd.log
	auth.debug	/var/adm/auth.log</verb>
<item>Edit a new file /etc/imapd.conf and place in it the following lines: 
<verb>	configdirectory: /var/imap
	partition-default: /var/spool/imap
    	admins: cyrus root
    	srvtab: /var/imap/srvtab
    	allowanonymouslogin: no
    	sasl_passwd_check: shadow</verb>
</enum></p>


<sect1>Creating the necessary directories
<p>This list of instructions will set up all the directories necessary for imap.</p>
<p><enum>
<item><tt>mkdir /var/adm</tt>
<item><tt>touch /var/adm/imapd.log /var/adm/auth.log</tt>
<item><tt>mkdir /var/imap /var/spool/imap /var/imap/srvtab</tt>
<item><tt>chown cyrus /var/imap /var/spool/imap /var/imap/srvtab</tt>
<item><tt>chgrp mail /var/imap /var/spool/imap /var/imap/srvtab</tt>
<item><tt>chmod 750 /var/imap /var/spool/imap /var/imap/srvtab</tt>
<item><tt>su cyrus</tt>
</enum></p>
<p>You are now the user cyrus. This is necessary for the files to have the correct owner and group.
Continue: </p>
<p><enum>
<item><tt>tools/mkimap</tt>
<item><tt>cd /var/imap</tt>
<item><tt>chattr +S . user quota user/* quota/*</tt>
<item><tt>chattr +S /var/spool/imap</tt>
<item><tt>exit</tt>
</enum></p>
<p>You are now root again. The last command: </p>
<p><tt>chattr +S /var/spool/mqueue</tt></p>

<sect1>More configuration file editing
<p><enum>
<item>Edit <em>/etc/services</em> and check for the following lines. If they do not exist, add them: 
<verb>	pop3	110/tcp
	imap	143/tcp
	imsp 	406/tcp
	kpop	1109/tcp
	sieve	2000/tcp</verb>
<item>Edit <em>/etc/inetd.conf</em> and comment out any imap and pop3 lines and add the following: 
<verb>	imap	stream	tcp	nowait	cyrus	/usr/cyrus/bin/imapd 	imapd
	pop3	stream	tcp	nowait	cyrus	/usr/cyrus/bin/imapd	pop3d</verb>
<item>Edit <em>/etc/sendmail.mc</em> with care not to add extra spaces and add the following lines:
<verb>	MAILER(local)
	MAILER(cyrus)
	define(`confLOCAL_MAILER',`cyrus') 
	LOCAL_RULE_0
	R$=N			$: $#local $: $1
	R$=N			$: $#local $: $1
	Rbb + $+ < @ $=w . >	$#cyrusbb $: $1</verb>
Then run:
<tt>m4 sendmail.mc > sendmail.cf</tt>
<item>Edit <em>/etc/group</em> and add the user daemon to the mail group.
</enum></p>

<sect> Cyrus IMAP Implementation

<sect1>Add the cyrus administrator
<p>Run the following command to set up a user for cyrus</p>
<p><tt>/usr/local/sbin/saslpasswd cyrus</tt></p>

<sect1>Testing Cyrus IMAP
<p><enum>
<item><tt>killall -HUP inetd</tt>
<item><tt>su cyrus</tt>
<item><tt>imtest -m login -p imap localhost</tt>
</enum></p>
<p>Enter your password. If you see something like: </p>
<p><verb>	(L01 OK User logged in means you're in)</verb></p>
<p>Then the setup has been successful. Type </p>
<p><verb>	. logout</verb></p>
<p>to log out. </p>

<sect1>Setting up users
<p>Still as the user cyrus, type the following commands. They will set up the
mailbox(es) for each user. Fill in the username where you see the (username).</p>
<p><enum>
<item><tt>cyradm localhost</tt>
<item><tt>cm user.(username)</tt>  (for all usernames)
<item><tt>quit</tt>
<item><tt>exit</tt> (back as root)
</enum></p>
<p>Now as root, enter a password for each username</p>
<p><tt>saslpasswd (username)</tt></p>

<sect1> Finishing up
<p>Reboot the machine to make sure that everything has been restarted under the new
configuration</p>

<sect>Troubleshooting
<p>If you encounter any errors, you can do the following to view error messages:</p>
<p><enum>	
<item><tt>tail /var/log/messages</tt>
<item><tt>tail /var/adm/imapd.log</tt>
<item><tt>killall sendmail && sendmail -bd -X /root/error.log</tt> (then read
/root/error.log)
</enum></p>

</article>
